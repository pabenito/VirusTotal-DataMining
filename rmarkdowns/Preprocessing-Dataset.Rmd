---
title: "Preprocessing Dataset"
author: "Pedro Antonio Benito Rojano"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Preprocessing Dataset

## Libraries

Library for read dataset.

```{r}
library(readr)
```

Library for data frames processing.

```{r message=FALSE}
library(dplyr)
library(tidyr)
```

Library for R Markdown.

```{r}
library(rmarkdown)
library(knitr)
```

Library for data presentation.

```{r message=FALSE}
library(scales)
```

Library for manage strings.

```{r}
library(stringr)
```

## Load dataset

Load dataset.

```{r message=FALSE}
df <- read_csv("../virusTotal/data/virusTotal.csv")
```

## Statistics

Dimensions.

```{r}
dim(df)
```
### Types

View witch types are in the dataset.

```{r}
col_types_all <- 
  df %>% 
  sapply(typeof) %>% 
  unlist()

col_types_table <- 
  col_types_all %>% 
  table()

col_types <- 
  col_types_table %>% 
  as.vector()

names(col_types) <- names(col_types_table)
```
```{r echo=FALSE}
col_types
```

As can be seen there are the three expected types: character, double and logical.

### NA

#### Percentaje of NA values

```{r}
num_of_NA <- 
  df %>% 
  is.na %>% 
  sum

num_of_values <- 
  df %>% 
  dim %>% 
  prod

NA_percentaje <- 
  (num_of_NA / num_of_values) %>% 
  percent
```
```{r echo=FALSE}
NA_percentaje
```

#### Columns with NA

Colums with NA.

```{r}
num_of_NA_by_column <- 
  df %>% 
  is.na %>% 
  colSums()

num_of_NA_by_column <- 
  num_of_NA_by_column[num_of_NA_by_column!=0]

names_of_colums_with_NA <- 
  names(num_of_NA_by_column)

num_of_cols_with_NA <- 
  num_of_NA_by_column %>% 
  length()

percentaje_of_cols_with_NA <-
  (num_of_cols_with_NA / ncol(df)) %>% 
  percent
```
```{r echo=FALSE}
sprintf("Number of colums with NA values: %d", num_of_cols_with_NA)
sprintf("Percentaje of colums with NA values: %s", as.character(percentaje_of_cols_with_NA))
```

Numeric colums with NA.

```{r}
num_of_numeric_cols_with_NA <- 
  df %>% 
  select_if(is.numeric) %>% 
  select_if(anyNA) %>% 
  ncol()

percentaje_of_numeric_cols_with_NA <- 
  (num_of_numeric_cols_with_NA / ncol(df)) %>% 
  percent()

names_of_numeric_colums_with_NA <- 
  df %>% 
  select_if(is.numeric) %>% 
  select_if(anyNA) %>% 
  colnames()
```
```{r echo=FALSE}
sprintf("Number of numeric colums with NA values: %d", num_of_numeric_cols_with_NA)
sprintf("Percentaje of numeric colums with NA values: %s", as.character(percentaje_of_numeric_cols_with_NA))
```
Inspect if there are columns full of NA.

```{r}
is_full_of_NA <- function(col){
  num_of_NA <- 
    col %>% 
    is.na() %>% 
    sum()
  return(num_of_NA == length(col))
}
```

```{r}
cols_full_of_NA <- 
  df %>% 
  select_if(is_full_of_NA) %>% 
  names()
```
```{r echo=FALSE}
cols_full_of_NA
```


As can be seen there are many columns that are full of NA, so can be deleted.

```{r}
df <- 
  df %>% 
  select(-all_of(cols_full_of_NA))
```

## Inspecting dataframe

Now let's deeply inspect into the dataframe.

```{r echo=FALSE}
df %>% paged_table()
```

### Replace NA for 0 into permissions colums

The permissions columns (PERM) seems that there are NAs where there should be 0s. 
So it would be better to replace them.

```{r}
replace_na_which_colname_match <- 
  function(df, pattern, replacement){
    cols_to_replace <- 
      df %>% 
      colnames() %>% 
      str_which(pattern)
    df_replaced_cols <- 
      df %>% 
      select(all_of(cols_to_replace)) %>% 
      sapply(function(col) replace_na(col, replacement))
    df_without_replaced_cols <- 
      df %>% 
      select(-all_of(cols_to_replace))
    return(cbind(df_without_replaced_cols, df_replaced_cols))
  }
```

```{r}
replace_na_when <- 
  function(df, exp, replacement){
    cols_to_replace <- 
      df %>% 
      select_if(function(col) eval.parent(exp, col)) %>% 
      colnames()
    df_replaced_cols <- 
      df %>% 
      select(all_of(cols_to_replace)) %>% 
      sapply(function(col) replace_na(col, replacement))
    df_without_replaced_cols <- 
      df %>% 
      select(-all_of(cols_to_replace))
    return(cbind(df_without_replaced_cols, df_replaced_cols))
  }
```

```{r}
pattern <- "additional_info.androguard.RiskIndicator.PERM"

df <- 
  df %>% 
  replace_na_which_colname_match(pattern, 0)

df %>% 
  select(., str_which(colnames(.), pattern)) %>% 
  paged_table()
```

```{r}
df_permissions <- 
  df %>% 
  select(., str_which(colnames(.), "additional_info.androguard.RiskIndicator.PERM")) %>% 
  sapply(function(col) replace_na(col, 0))

df_without_permissions <- 
  df %>% 
  select(., -c(str_which(colnames(.), "additional_info.androguard.RiskIndicator.PERM")))

df <- cbind(df_permissions, df_without_permissions)
```

## As factor

```{r}
labels <- 
  function(n){
    if(n == 5){
      return(c("very low", "low", "medium", "high", "very high"))
    }else if(n == 4){
      return(c("very low", "low", "high", "very high"))
    }else if(n == 3){
      return(c("low", "medium", "high"))
    }else if(n == 2){
      return(c("low", "high"))
    }else{
      stop("Not avalible")
    }
  }

cut_by_quantiles <- 
  function(col){
    quantiles <- 
      col %>% 
      na.omit() %>% 
      quantile() %>% 
      unique()
    if(length(quantiles) > 2){
      col <- 
        col %>% 
        cut(breaks = quantiles, labels = labels(length(quantiles)-1))
    }
    return(col)
  }

df_cut_by_quantiles <- 
  function(df){
    df_without_numeric <- df[!is.numeric(df)]
    df_numeric <- 
      df %>% 
      select_if(is.numeric)
    df_numeric <- 
      df_numeric %>% 
      lapply(cut_by_quantiles)
    return(cbind(df_without_numeric, df_numeric))
  }

df_test <- 
  df_cut_by_quantiles(df)
```











