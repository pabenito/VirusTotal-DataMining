---
title: "Preprocessing Dataset"
author: "Pedro Antonio Benito Rojano"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Preprocessing Dataset

## Libraries

Library for read dataset.

```{r}
library(readr)
```

Library for data frames processing.

```{r message=FALSE}
library(dplyr)
library(tidyr)
```

Library for R Markdown.

```{r}
library(rmarkdown)
library(knitr)
```

Library for data presentation.

```{r message=FALSE}
library(scales)
```

Library for manage strings.

```{r}
library(stringr)
```

## Load dataset

Load dataset.

```{r message=FALSE}
df <- read_csv("../virusTotal/data/virusTotal.csv")
```

## Statistics

Dimensions.

```{r}
dim(df)
```
### Types

View witch types are in the dataset.

```{r}
col_types_all <- 
  df %>% 
  sapply(typeof) %>% 
  unlist()

col_types_table <- 
  col_types_all %>% 
  table()

col_types <- 
  col_types_table %>% 
  as.vector()

names(col_types) <- names(col_types_table)
```
```{r echo=FALSE}
col_types
```

As can be seen there are the three expected types: character, double and logical.

### NA

#### Percentaje of NA values

Define function to see the amount of NA values in the dataframe. 

```{r}
percent_of_NA <- 
  function(df){
    num_of_NA <- 
      df %>% is.na() %>% sum()
    num_of_values <- 
      df %>% dim() %>% prod()
    percent_of_NA <- 
      (num_of_NA / num_of_values) %>% 
      percent()
    return(percent_of_NA)
  }
```

```{r}
percent_of_NA(df)
```

#### Columns with NA

Define functions to see the NA in columns.

```{r}
num_of_NA_by_column <- 
  function(df){
    df %>% is.na() %>% colSums()
  }
```

```{r}
remove_0 <- 
  function(x) x[x!=0]
```

```{r}
names_of_colums_with_NA <- 
  function(df)
    df %>% 
      num_of_NA_by_column() %>% 
      remove_0 %>% 
      names()
```

```{r}
percentaje_of_cols_with_NA <-
  function(df)
    (length(names_of_colums_with_NA(df)) / ncol(df)) %>% 
    percent()
```

Compute the percentaje of cols with NA.

```{r}
percentaje_of_cols_with_NA(df)
```

Inspect if there are columns full of NA.

```{r}
is_full_of_NA <- function(col){
  num_of_NA <- 
    col %>% 
    is.na() %>% 
    sum()
  return(num_of_NA == length(col))
}
```

```{r}
cols_full_of_NA <- 
  df %>% 
  select_if(is_full_of_NA) %>% 
  names()
```
```{r echo=FALSE}
cols_full_of_NA
```


As can be seen there are many columns that are full of NA, so can be deleted.

```{r}
df <- 
  df %>% 
  select(-all_of(cols_full_of_NA))
```

#### Colums with the same value

Maybe there are columns that has the same value along all the vector, so are useless.

Define function to remove these columns.

```{r}
remove_columns_with_the_same_value <- 
  function(df)
      select_if(df, function(col) length(unique(col)) > 1)
```

Apply function.

```{r}
df_test <- 
  remove_columns_with_the_same_value(df)
```

Calculate the number of columns deleted.

```{r}
ncol(df) - ncol(df_test) 
```

Awesom! 



## Inspecting dataframe

Now let's deeply inspect into the dataframe.

```{r echo=FALSE}
df %>% paged_table()
```

### Replace NA for 0 into permissions colums

The permissions columns (PERM) seems that there are NAs where there should be 0s. 
So it would be better to replace them.

```{r}
replace_na_which_colname_match <- 
  function(df, pattern, replacement){
    cols_to_replace <- 
      df %>% 
      colnames() %>% 
      str_which(pattern)
    df_replaced_cols <- 
      df %>% 
      select(all_of(cols_to_replace)) %>% 
      sapply(function(col) replace_na(col, replacement))
    df_without_replaced_cols <- 
      df %>% 
      select(-all_of(cols_to_replace))
    return(cbind(df_without_replaced_cols, df_replaced_cols))
  }
```

```{r}
replace_na_when <- 
  function(df, fun, replacement){
    cols_to_replace <- 
      df %>% 
      select_if(fun) %>% 
      colnames()
    df_replaced_cols <- 
      df %>% 
      select(all_of(cols_to_replace)) %>% 
      sapply(function(col) replace_na(col, replacement))
    df_without_replaced_cols <- 
      df %>% 
      select(-all_of(cols_to_replace))
    return(cbind(df_without_replaced_cols, df_replaced_cols))
  }
```

```{r}
pattern <- "additional_info.androguard.RiskIndicator.PERM"

df <- 
  df %>% 
  replace_na_which_colname_match(pattern, 0)

df %>% 
  select(., str_which(colnames(.), pattern)) %>% 
  paged_table()
```

```{r}
df_permissions <- 
  df %>% 
  select(., str_which(colnames(.), "additional_info.androguard.RiskIndicator.PERM")) %>% 
  sapply(function(col) replace_na(col, 0))

df_without_permissions <- 
  df %>% 
  select(., -c(str_which(colnames(.), "additional_info.androguard.RiskIndicator.PERM")))

df <- cbind(df_permissions, df_without_permissions)
```

## As factor

```{r}
labels <- 
  function(n){
    if(n == 5){
      return(c("very low", "low", "medium", "high", "very high"))
    }else if(n == 4){
      return(c("very low", "low", "high", "very high"))
    }else if(n == 3){
      return(c("low", "medium", "high"))
    }else if(n == 2){
      return(c("low", "high"))
    }else{
      stop("Not avalible")
    }
  }

cut_by_quantiles <- 
  function(col){
    quantiles <- 
      col %>% 
      quantile(na.rm = TRUE) %>% 
      unique()
    if(length(quantiles) > 2){
      col <- 
        col %>% 
        cut(breaks = quantiles, 
            labels = labels(length(quantiles)-1),
            include.lowest = TRUE)
    }
    return(col)
  }

df_cut_by_quantiles <- 
  function(df){
    df_without_numeric <- 
      df[sapply(df, function(col) !is.numeric(col))]
    df_numeric <- 
      df %>% 
      select_if(is.numeric)
    df_numeric <- 
      df_numeric %>% 
      lapply(cut_by_quantiles)
    return(cbind(df_without_numeric, df_numeric))
  }
```

## Col total permissions

```{r}
pattern <- "additional_info.androguard.RiskIndicator.PERM"

df_without_permissions <- 
  df %>% 
  select(., -(str_which(colnames(.), pattern)))

df_permissions <- 
  df %>% 
  select(., str_which(colnames(.), pattern)) %>% 
  mutate(., total_PERMs = rowSums(.))

df <- cbind(df_without_permissions, df_permissions)
```













